// bunda lcd de akis hizli am akemer ok motor ok kalanlarda ok zaten 

#include <Wire.h>
#include <LiquidCrystal_I2C.h>

LiquidCrystal_I2C lcd(0x3F, 16, 2); // LCD adresi 0x27 de olabilir

// Pin tanımları
const int motorButtonPin = 19;        // PD2/RXD1/INT2 (motor butonu)
const int seatBeltButtonPin = 18;     // PD3/TXD1/INT3 (emniyet kemeri butonu)
const int redLedPin = 5;              // PE3/OC3A/AIN1 (kırmızı LED - kemer uyarısı)
const int buzzerPin = 10;
const int potPin = A2;
const int fuelLedPin = 7;
const int motorLedPin = 13;           // İsteğe bağlı gösterge LED (motor durumu)
const int dcMotorPin = 2;             // PE4 / D2 → Gerçek motor kontrol pini
const int tempPin = A0;               // LM35 sıcaklık sensörü
const int fanMotorPin = 9;            // PH6, fan (DC motor - klima)
const int doorSwitchPin = 6;          // PH3 (kapı anahtarı)
const int doorLedPin = 3;             // PE5 (pembe RGB LED: R + B)
const int ldrPin = A1;                // LDR bağlı analog pin
const int farLedPin = A14;            // Mavi LED (Far) A14'e bağlı

bool motorDurumu = false;
bool oncekiButon = LOW;
unsigned long lcdTimer = 0;
unsigned long lcdShowTime = 4000;
String lcdSatir1 = "";
String lcdSatir2 = "";

void lcd_hazirla() {
  lcd.init();
  lcd.backlight();
  lcd.setCursor(0, 0);
  lcd.print("Test LCD");
  delay(1000);
  lcd.clear();
}

void pin_hazirla() {
  pinMode(motorButtonPin, INPUT_PULLUP);
  pinMode(seatBeltButtonPin, INPUT_PULLUP);
  pinMode(redLedPin, OUTPUT);
  pinMode(buzzerPin, OUTPUT);
  pinMode(fuelLedPin, OUTPUT);
  pinMode(motorLedPin, OUTPUT);
  pinMode(dcMotorPin, OUTPUT);
  pinMode(fanMotorPin, OUTPUT);
  pinMode(doorSwitchPin, INPUT_PULLUP);
  pinMode(doorLedPin, OUTPUT);
  pinMode(farLedPin, OUTPUT);
}

void guncelleLCD(String satir1, String satir2, unsigned long sure = 2000) {
  if (satir1 != lcdSatir1 || satir2 != lcdSatir2) {
    lcd.clear();
    lcd.setCursor(0, 0);
    lcd.print(satir1);
    lcd.setCursor(0, 1);
    lcd.print(satir2);
    lcdSatir1 = satir1;
    lcdSatir2 = satir2;
    lcdTimer = millis();
    lcdShowTime = sure;
  }
}

void setup() {
  pin_hazirla();
  lcd_hazirla();
}

void loop() {
  int motorButton = digitalRead(motorButtonPin);
  int seatBelt = digitalRead(seatBeltButtonPin);
  int potDeger = analogRead(potPin);
  int yakitYuzde = map(potDeger, 0, 1023, 0, 100);
  int doorState = digitalRead(doorSwitchPin);
  int ldrDeger = analogRead(ldrPin);

  int tempRaw = analogRead(tempPin);
  float voltage = (tempRaw / 1023.0) * 5.0;
  float sicaklik = voltage * 100.0;

  // LCD süresi dolduysa otomatik temizle
  if (millis() - lcdTimer > lcdShowTime) {
    lcdSatir1 = "";
    lcdSatir2 = "";
    lcd.clear();
  }

  // Kapı kontrolü
  if (doorState == LOW) {
    digitalWrite(doorLedPin, HIGH);
    guncelleLCD("Uyari: Kapi Acik", "Motor Calismaz");
    motorDurumu = false;
    digitalWrite(motorLedPin, LOW);
    digitalWrite(dcMotorPin, LOW);
    return;
  } else {
    digitalWrite(doorLedPin, LOW);
  }

  // Sıcaklık kontrolü
  if (sicaklik >= 25.0) {
    digitalWrite(fanMotorPin, HIGH);
    guncelleLCD("Sicaklik: " + String((int)sicaklik) + (char)223 + "C", "Klima Acildi");
  } else {
    digitalWrite(fanMotorPin, LOW);
    guncelleLCD("Sicaklik: " + String((int)sicaklik) + (char)223 + "C", "Klima Kapandi");
  }

  // Far kontrolü
  if (ldrDeger <= 250) {
    digitalWrite(farLedPin, HIGH);
    guncelleLCD("Farlar Acik", "");
  } else {
    digitalWrite(farLedPin, LOW);
    guncelleLCD("Farlar Kapandi", "");
  }

  // Emniyet kemeri kontrolü
  if (seatBelt == HIGH) {
    digitalWrite(redLedPin, HIGH);
    digitalWrite(buzzerPin, HIGH);
    guncelleLCD("Kemer Takili Degil!", "");
    motorDurumu = false;
    digitalWrite(motorLedPin, LOW);
    digitalWrite(dcMotorPin, LOW);
    return;
  } else {
    digitalWrite(redLedPin, LOW);
    digitalWrite(buzzerPin, LOW);
    guncelleLCD("Kemer Takildi", "");
  }

  // Yakıt kontrolü
  if (yakitYuzde == 0) {
    motorDurumu = false;
    digitalWrite(motorLedPin, LOW);
    digitalWrite(dcMotorPin, LOW);
    guncelleLCD("Yakit Bitti", "Motor Durdu");
    digitalWrite(fuelLedPin, LOW);
    digitalWrite(redLedPin, LOW);
    digitalWrite(buzzerPin, HIGH);
    return;
  }

  // Motor buton kontrolü
  if (motorButton == LOW && oncekiButon == HIGH) {
    motorDurumu = !motorDurumu;
    guncelleLCD(motorDurumu ? "Motor ok" : "Motor Durdu", "");
  }

  oncekiButon = motorButton;
  digitalWrite(motorLedPin, motorDurumu);
  digitalWrite(dcMotorPin, motorDurumu);

  // Yakıt seviyesi gösterimi
  lcd.setCursor(0, 1);
  lcd.print("Yakit: ");
  lcd.print(yakitYuzde);
  lcd.print("%   ");

  if (yakitYuzde <= 5) {
    lcd.setCursor(0, 0);
    lcd.print("Kritik: Yakit Az ");
    digitalWrite(fuelLedPin, millis() / 300 % 2);
  } else if (yakitYuzde <= 10) {
    lcd.setCursor(0, 0);
    lcd.print("Uyari: Yakit Az  ");
    digitalWrite(fuelLedPin, HIGH);
  } else {
    digitalWrite(fuelLedPin, LOW);
  }
}
